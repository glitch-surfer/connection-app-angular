"use strict";(self.webpackChunkconnection=self.webpackChunkconnection||[]).push([[365],{9365:(X,x,o)=>{o.r(x),o.d(x,{ConversationComponent:()=>B});var d=o(6814),c=o(6223),h=o(2072),O=o(5619),P=o(5940),t=o(9212),l=o(7398),$=o(2572),I=o(1687),g=o(9397),p=o(6306),m=o(6232),f=o(4716),S=o(2181),y=o(4664),A=o(418),b=o(1831),Z=o(5295),v=o(192),E=o(3753),T=o(3463);const L=n=>n.conversations;var u=o(517),U=o(7250),N=o(2169),k=o(8833),w=o(8168),F=o(7700);let J=(()=>{class n{constructor(e,s,i,C,j,K){this.conversationHttpService=e,this.store=s,this.notificationService=i,this.router=C,this.peopleListService=j,this.dialog=K,this.since={},this.messagesRaw$=this.store.select(L).pipe((0,l.U)(r=>r[this.conversationId]?r[this.conversationId].messages:[])),this.peoples$=this.store.select(T.U),this.loading$$=new O.X(!1),this.loading$=this.loading$$.asObservable(),this.conversationId="",this.isConversationExist$=this.peoples$.pipe((0,l.U)(r=>r.find(M=>M.conversationId===this.conversationId))),this.userId$=this.store.select(Z.t).pipe((0,l.U)(r=>r.uid)),this.messages$=(0,$.a)([this.messagesRaw$,this.peoples$]).pipe((0,l.U)(([r,M])=>r.map(_=>({..._,author:M.find(V=>V.uid===_.authorID)?.name??"Me"})))),this.timers={}}initConversation(){this.peopleListService.initPeoplesList(),this.getMessages()}setTimer(){const e=this.timers[this.conversationId];if(e.getValue())return;let s=b.l;const i=(0,I.F)(b.W).subscribe(()=>{0!==s?(s-=1,e.next(s)):i.unsubscribe()})}getMessages(){this.loading$$.next(!0),this.conversationHttpService.getMessages(this.conversationId,this.since[this.conversationId]??"").pipe((0,l.U)(e=>(0,A.r)(e)),(0,l.U)(e=>e.sort((s,i)=>+s.createdAt-+i.createdAt).slice()),(0,g.b)(e=>{const s=!this.since[this.conversationId];e.length>0&&(this.since[this.conversationId]=e[e.length-1].createdAt),this.store.dispatch(s?(0,u.Ox)({conversationId:this.conversationId,messages:e}):(0,u.JE)({conversationId:this.conversationId,messages:e}))}),(0,p.K)(()=>(this.notificationService.error(v.T.ERROR_LOAD_MESSAGES),m.E)),(0,f.x)(()=>this.loading$$.next(!1))).subscribe()}deleteConversation(){this.dialog.open(E.S,{data:{title:"Delete conversation",content:"Are you sure you want to delete this conversation?",confirmButtonText:"Delete"}}).afterClosed().pipe((0,S.h)(Boolean),(0,g.b)(()=>this.loading$$.next(!0)),(0,y.w)(()=>this.conversationHttpService.deleteConversation(this.conversationId)),(0,g.b)(()=>this.store.dispatch((0,u.xm)({id:this.conversationId}))),(0,g.b)(()=>this.notificationService.success(v.T.SUCCESS_DELETE_CONVERSATION)),(0,g.b)(()=>this.router.navigate(["/"])),(0,p.K)(()=>(this.notificationService.error(v.T.ERROR_DELETE_CONVERSATION),m.E)),(0,f.x)(()=>this.loading$$.next(!1))).subscribe()}sendMessage(e){this.loading$$.next(!0),this.conversationHttpService.sendMessage(this.conversationId,e).pipe((0,g.b)(()=>this.getMessages()),(0,p.K)(()=>(this.notificationService.error(v.T.ERROR_SEND_MESSAGE),m.E)),(0,f.x)(()=>this.loading$$.next(!1))).subscribe()}static#t=this.\u0275fac=function(s){return new(s||n)(t.LFG(U.r),t.LFG(N.yh),t.LFG(k.g),t.LFG(h.F0),t.LFG(w.B),t.LFG(F.uw))};static#e=this.\u0275prov=t.Yz7({token:n,factory:n.\u0275fac,providedIn:"root"})}return n})();function R(n,a){1&n&&t._UZ(0,"mat-spinner",3)}function D(n,a){if(1&n&&(t.TgZ(0,"span"),t._uU(1),t.ALo(2,"async"),t.qZA()),2&n){const e=t.oxw(3);t.xp6(1),t.hij(" (timeout: ",t.lcZ(2,1,e.timer$),")")}}function z(n,a){if(1&n&&(t.TgZ(0,"li",13),t.ALo(1,"async"),t.TgZ(2,"span"),t._uU(3),t.ALo(4,"date"),t.qZA(),t._uU(5),t.qZA()),2&n){const e=a.$implicit,s=t.oxw(3);t.ekj("user-messages",t.lcZ(1,5,s.userId$)===e.authorID),t.xp6(3),t.hij("(",t.lcZ(4,7,e.createdAt),")"),t.xp6(2),t.AsE(" ",e.author,": ",e.message," ")}}function G(n,a){1&n&&(t.TgZ(0,"li"),t._uU(1,"No messages yet"),t.qZA())}function H(n,a){if(1&n){const e=t.EpF();t.ynx(0),t.TgZ(1,"div",6)(2,"button",7),t.NdJ("click",function(){t.CHM(e);const i=t.oxw(2);return t.KtG(i.onUpdateMessages())}),t.ALo(3,"async"),t.ALo(4,"async"),t._uU(5," Update"),t.YNc(6,D,3,3,"span",8),t.ALo(7,"async"),t.qZA(),t.TgZ(8,"button",7),t.NdJ("click",function(){t.CHM(e);const i=t.oxw(2);return t.KtG(i.onDeleteConversation())}),t.ALo(9,"async"),t._uU(10,"Delete"),t.qZA()(),t.TgZ(11,"ul",9),t.YNc(12,z,6,9,"li",10),t.ALo(13,"async"),t.YNc(14,G,2,0,"li",8),t.ALo(15,"async"),t.qZA(),t.TgZ(16,"div",11),t._UZ(17,"input",12),t.TgZ(18,"button",7),t.NdJ("click",function(){t.CHM(e);const i=t.oxw(2);return t.KtG(i.onSendMessage())}),t.ALo(19,"async"),t._uU(20," Send "),t.qZA()(),t.BQk()}if(2&n){const e=t.oxw(2);let s;t.xp6(2),t.Q6J("disabled",t.lcZ(3,7,e.timer$)||t.lcZ(4,9,e.loading$)),t.xp6(4),t.Q6J("ngIf",t.lcZ(7,11,e.timer$)),t.xp6(2),t.Q6J("disabled",t.lcZ(9,13,e.loading$)),t.xp6(4),t.Q6J("ngForOf",t.lcZ(13,15,e.messages$)),t.xp6(2),t.Q6J("ngIf",!(null!=(s=t.lcZ(15,17,e.messages$))&&s.length)),t.xp6(3),t.Q6J("formControl",e.newMessage),t.xp6(1),t.Q6J("disabled",t.lcZ(19,19,e.loading$)||e.newMessage.invalid)}}function Q(n,a){1&n&&(t.TgZ(0,"p",14),t._uU(1,"Conversation doesn't exist"),t.qZA())}function Y(n,a){if(1&n&&(t.YNc(0,H,21,21,"ng-container",4),t.ALo(1,"async"),t.YNc(2,Q,2,0,"ng-template",null,5,t.W1O)),2&n){const e=t.MAs(3),s=t.oxw();t.Q6J("ngIf",!!t.lcZ(1,2,s.isConversationExist$))("ngIfElse",e)}}let B=(()=>{class n{constructor(e,s){this.conversationService=e,this.router=s,this.newMessage=new c.NI("",{validators:[c.kI.required]}),this.loading$=this.conversationService.loading$,this.messages$=this.conversationService.messages$,this.isConversationExist$=this.conversationService.isConversationExist$,this.userId$=this.conversationService.userId$}ngOnInit(){this.conversationService.conversationId=this.router.snapshot.params.id,this.conversationService.timers[this.conversationService.conversationId]||(this.conversationService.timers[this.conversationService.conversationId]=new O.X(0)),this.timer$=this.conversationService.timers[this.conversationService.conversationId],this.conversationService.initConversation()}onUpdateMessages(){this.conversationService.setTimer(),this.conversationService.getMessages()}onDeleteConversation(){this.conversationService.deleteConversation()}onSendMessage(){this.newMessage.invalid||!this.newMessage.value||(this.conversationService.sendMessage(this.newMessage.value),this.newMessage.setValue(""))}static#t=this.\u0275fac=function(s){return new(s||n)(t.Y36(J),t.Y36(h.gz))};static#e=this.\u0275cmp=t.Xpm({type:n,selectors:[["app-conversation"]],standalone:!0,features:[t.jDz],decls:6,vars:4,consts:[["routerLink","/"],["class","spinner",4,"ngIf","ngIfElse"],["content",""],[1,"spinner"],[4,"ngIf","ngIfElse"],["notExist",""],[1,"btn-wrapper"],[1,"btn",3,"disabled","click"],[4,"ngIf"],[1,"messages"],["class","messages__item",3,"user-messages",4,"ngFor","ngForOf"],[1,"input-wrapper"],["type","text","placeholder","Message",1,"input",3,"formControl"],[1,"messages__item"],[1,"error-title"]],template:function(s,i){if(1&s&&(t.TgZ(0,"a",0),t._uU(1,"Back"),t.qZA(),t.YNc(2,R,1,0,"mat-spinner",1),t.ALo(3,"async"),t.YNc(4,Y,4,4,"ng-template",null,2,t.W1O)),2&s){const C=t.MAs(5);t.xp6(2),t.Q6J("ngIf",t.lcZ(3,2,i.loading$))("ngIfElse",C)}},dependencies:[d.ez,d.sg,d.O5,d.Ov,d.uU,c.UX,c.Fj,c.JJ,c.oH,h.Bz,h.rH,P.Cq,P.Ou],styles:["*[_ngcontent-%COMP%]{box-sizing:border-box;margin:0;padding:0}html[_ngcontent-%COMP%], body[_ngcontent-%COMP%]{height:100%}body[_ngcontent-%COMP%]{background-color:#e3f2fd;font-family:Roboto,Helvetica Neue,sans-serif}body.dark-theme[_ngcontent-%COMP%]{background-color:#283593;color:#e3f2fd}a[_ngcontent-%COMP%], a[_ngcontent-%COMP%]:visited{color:#3f51b5}a[_ngcontent-%COMP%]:hover, a[_ngcontent-%COMP%]:visited:hover{opacity:.8}a[_ngcontent-%COMP%]:active, a[_ngcontent-%COMP%]:visited:active{opacity:.6}.dark-theme[_ngcontent-%COMP%]   a[_ngcontent-%COMP%], .dark-theme[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:visited{color:#e89126}.error-snackbar[_ngcontent-%COMP%]{width:-moz-fit-content;width:fit-content;color:#3f51b5;background-color:#e3f2fd;border-bottom:3px solid #ff0000}.success-snackbar[_ngcontent-%COMP%]{width:-moz-fit-content;width:fit-content;color:#3f51b5;background-color:#e3f2fd;border-bottom:3px solid #00ff00}button[_ngcontent-%COMP%]:disabled{color:#757575}.btn[_ngcontent-%COMP%]{height:36px;padding:0 1rem;align-self:flex-start;color:#fafafa;background-color:#424242;border-radius:4px;border:none;cursor:pointer}.btn[_ngcontent-%COMP%]:hover{opacity:.9}.btn[_ngcontent-%COMP%]:disabled{background-color:#b8b1b1;opacity:1;cursor:not-allowed}.input[_ngcontent-%COMP%]{width:100%;padding:0 .5rem;background-color:transparent;border:1px solid #3f51b5;border-radius:4px}.messages[_ngcontent-%COMP%]{max-height:50vh;display:flex;flex-direction:column;gap:.25rem;padding:.5rem;border:1px solid #283593;border-radius:4px;list-style:none;overflow:auto}.messages__item[_ngcontent-%COMP%]{margin-right:2rem;padding:.5rem;width:-moz-fit-content;width:fit-content;display:flex;flex-direction:column;gap:.25rem;border:1px solid #3f51b5;border-radius:4px;background-color:#9cd1f8}.user-messages[_ngcontent-%COMP%]{margin-right:0;margin-left:2rem;align-self:flex-end}.spinner[_ngcontent-%COMP%]{margin-top:1rem;align-self:center}[_nghost-%COMP%]{max-width:800px;margin:0 auto;padding:1rem;display:flex;flex-direction:column;gap:1rem}.btn-wrapper[_ngcontent-%COMP%]{display:flex;gap:1rem}.input-wrapper[_ngcontent-%COMP%]{display:flex;gap:.5rem}.error-title[_ngcontent-%COMP%]{margin-top:3rem;font-size:2rem;text-align:center}.dark-theme[_nghost-%COMP%]   a[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   a[_ngcontent-%COMP%], .dark-theme[_nghost-%COMP%]   a[_ngcontent-%COMP%]:visited, .dark-theme   [_nghost-%COMP%]   a[_ngcontent-%COMP%]:visited{color:#e89126}.dark-theme[_nghost-%COMP%]   .input-wrapper[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .input-wrapper[_ngcontent-%COMP%]{display:flex;gap:.5rem}.dark-theme[_nghost-%COMP%]   .input[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .input[_ngcontent-%COMP%]{color:#e3f2fd;border-color:#e89126}.dark-theme[_nghost-%COMP%]   .messages[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .messages[_ngcontent-%COMP%]{border-color:#e89126}.dark-theme[_nghost-%COMP%]   .messages__item[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .messages__item[_ngcontent-%COMP%]{border-color:#e89126;background-color:#af6913}"]})}return n})()}}]);