import{a as xe,b as be,c as Oe}from"./chunk-IOG2XBG3.js";import{a as Me}from"./chunk-K5VTYB75.js";import{b as ge,c as fe,d as ve,e as ue,f as Ce}from"./chunk-FU4DWJD5.js";import"./chunk-UB4EZDCW.js";import{a as he}from"./chunk-QKVZ2CT4.js";import{b as oe}from"./chunk-GSZV43AH.js";import{a as re,b as se,c as ae,d as ce,f as pe,j as le,l as de,o as me,y as C,z as _e}from"./chunk-2SKVBX5T.js";import"./chunk-S5VQBE6T.js";import{Aa as g,Ab as ee,Ca as c,Cb as te,Da as p,Db as ne,Ea as k,F as j,Fa as z,Fb as ie,Ga as G,H as v,Ia as q,L as F,Ma as I,O as u,Oa as _,Q as H,Ra as w,Sa as d,U as P,Ua as R,V as S,Va as Y,Xa as J,Za as r,_a as s,a as B,b as A,eb as T,f as M,h as x,l as f,la as a,lb as K,m as N,ma as E,mb as Q,qb as W,r as L,rb as X,sb as Z,t as V,v as b,va as l,xa as U,z as O}from"./chunk-5IAL5MBJ.js";var Pe=t=>t.conversations;var Se=(()=>{let i=class i{constructor(e,n,h,$,Ie,$e){this.conversationHttpService=e,this.store=n,this.notificationService=h,this.router=$,this.peopleListService=Ie,this.dialog=$e,this.since={},this.messagesRaw$=this.store.select(Pe).pipe(f(m=>m[this.conversationId]?m[this.conversationId].messages:[])),this.peoples$=this.store.select(ve),this.loading$$=new M(!1),this.loading$=this.loading$$.asObservable(),this.conversationId="",this.isConversationExist$=this.peoples$.pipe(f(m=>m.find(y=>y.conversationId===this.conversationId))),this.userId$=this.store.select(he).pipe(f(m=>m.uid)),this.messages$=N([this.messagesRaw$,this.peoples$]).pipe(f(([m,y])=>m.map(D=>A(B({},D),{author:y.find(ye=>ye.uid===D.authorID)?.name??"Me"})))),this.timers={}}initConversation(){this.peopleListService.initPeoplesList(),this.getMessages()}setTimer(){let e=this.timers[this.conversationId];if(e.getValue())return;let n=60,h=L(1e3).subscribe(()=>{if(n===0){h.unsubscribe();return}n-=1,e.next(n)})}getMessages(){this.loading$$.next(!0),this.conversationHttpService.getMessages(this.conversationId,this.since[this.conversationId]??"").pipe(f(e=>Me(e)),f(e=>e.sort((n,h)=>+n.createdAt-+h.createdAt).slice()),v(e=>{let n=!this.since[this.conversationId];e.length>0&&(this.since[this.conversationId]=e[e.length-1].createdAt),this.store.dispatch(n?xe({conversationId:this.conversationId,messages:e}):be({conversationId:this.conversationId,messages:e}))}),b(()=>(this.notificationService.error(C.ERROR_LOAD_MESSAGES),x)),O(()=>this.loading$$.next(!1))).subscribe()}deleteConversation(){this.dialog.open(fe,{data:{title:"Delete conversation",content:"Are you sure you want to delete this conversation?",confirmButtonText:"Delete"}}).afterClosed().pipe(V(Boolean),v(()=>this.loading$$.next(!0)),j(()=>this.conversationHttpService.deleteConversation(this.conversationId)),v(()=>this.store.dispatch(Oe({id:this.conversationId}))),v(()=>this.notificationService.success(C.SUCCESS_DELETE_CONVERSATION)),v(()=>this.router.navigate(["/"])),b(()=>(this.notificationService.error(C.ERROR_DELETE_CONVERSATION),x)),O(()=>this.loading$$.next(!1))).subscribe()}sendMessage(e){this.loading$$.next(!0),this.conversationHttpService.sendMessage(this.conversationId,e).pipe(v(()=>this.getMessages()),b(()=>(this.notificationService.error(C.ERROR_SEND_MESSAGE),x)),O(()=>this.loading$$.next(!1))).subscribe()}};i.\u0275fac=function(n){return new(n||i)(u(ue),u(oe),u(_e),u(te),u(Ce),u(ge))},i.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"});let t=i;return t})();function De(t,i){t&1&&k(0,"mat-spinner",3)}function Be(t,i){if(t&1&&(c(0,"span"),d(1),r(2,"async"),p()),t&2){let o=_(3);a(1),R(" (timeout: ",s(2,1,o.timer$),")")}}function Ae(t,i){if(t&1&&(c(0,"li",13),r(1,"async"),c(2,"span"),d(3),r(4,"date"),p(),d(5),p()),t&2){let o=i.$implicit,e=_(3);U("user-messages",s(1,5,e.userId$)===o.authorID),a(3),R("(",s(4,7,o.createdAt),")"),a(2),Y(" ",o.author,": ",o.message," ")}}function Ne(t,i){t&1&&(c(0,"li"),d(1,"No messages yet"),p())}function Le(t,i){if(t&1){let o=q();z(0),c(1,"div",6)(2,"button",7),I("click",function(){P(o);let n=_(2);return S(n.onUpdateMessages())}),r(3,"async"),r(4,"async"),d(5," Update"),g(6,Be,3,3,"span",8),r(7,"async"),p(),c(8,"button",7),I("click",function(){P(o);let n=_(2);return S(n.onDeleteConversation())}),r(9,"async"),d(10,"Delete"),p()(),c(11,"ul",9),g(12,Ae,6,9,"li",10),r(13,"async"),g(14,Ne,2,0,"li",8),r(15,"async"),p(),c(16,"div",11),k(17,"input",12),c(18,"button",7),I("click",function(){P(o);let n=_(2);return S(n.onSendMessage())}),r(19,"async"),d(20," Send "),p()(),G()}if(t&2){let o=_(2),e;a(2),l("disabled",s(3,7,o.timer$)||s(4,9,o.loading$)),a(4),l("ngIf",s(7,11,o.timer$)),a(2),l("disabled",s(9,13,o.loading$)),a(4),l("ngForOf",s(13,15,o.messages$)),a(2),l("ngIf",!((e=s(15,17,o.messages$))!=null&&e.length)),a(3),l("formControl",o.newMessage),a(1),l("disabled",s(19,19,o.loading$)||o.newMessage.invalid)}}function Ve(t,i){t&1&&(c(0,"p",14),d(1,"Conversation doesn't exist"),p())}function je(t,i){if(t&1&&(g(0,Le,21,21,"ng-container",4),r(1,"async"),g(2,Ve,2,0,"ng-template",null,5,T)),t&2){let o=w(3),e=_();l("ngIf",!!s(1,2,e.isConversationExist$))("ngIfElse",o)}}var dt=(()=>{let i=class i{constructor(e,n){this.conversationService=e,this.router=n,this.newMessage=new le("",{validators:[ce.required]}),this.loading$=this.conversationService.loading$,this.messages$=this.conversationService.messages$,this.isConversationExist$=this.conversationService.isConversationExist$,this.userId$=this.conversationService.userId$}ngOnInit(){this.conversationService.conversationId=this.router.snapshot.params.id,this.conversationService.timers[this.conversationService.conversationId]||(this.conversationService.timers[this.conversationService.conversationId]=new M(0)),this.timer$=this.conversationService.timers[this.conversationService.conversationId],this.conversationService.initConversation()}onUpdateMessages(){this.conversationService.setTimer(),this.conversationService.getMessages()}onDeleteConversation(){this.conversationService.deleteConversation()}onSendMessage(){this.newMessage.invalid||!this.newMessage.value||(this.conversationService.sendMessage(this.newMessage.value),this.newMessage.setValue(""))}};i.\u0275fac=function(n){return new(n||i)(E(Se),E(ee))},i.\u0275cmp=H({type:i,selectors:[["app-conversation"]],standalone:!0,features:[J],decls:6,vars:4,consts:[["routerLink","/"],["class","spinner",4,"ngIf","ngIfElse"],["content",""],[1,"spinner"],[4,"ngIf","ngIfElse"],["notExist",""],[1,"btn-wrapper"],[1,"btn",3,"disabled","click"],[4,"ngIf"],[1,"messages"],["class","messages__item",3,"user-messages",4,"ngFor","ngForOf"],[1,"input-wrapper"],["type","text","placeholder","Message",1,"input",3,"formControl"],[1,"messages__item"],[1,"error-title"]],template:function(n,h){if(n&1&&(c(0,"a",0),d(1,"Back"),p(),g(2,De,1,0,"mat-spinner",1),r(3,"async"),g(4,je,4,4,"ng-template",null,2,T)),n&2){let $=w(5);a(2),l("ngIf",s(3,2,h.loading$))("ngIfElse",$)}},dependencies:[Z,K,Q,W,X,me,ae,pe,de,ie,ne,se,re],styles:["*[_ngcontent-%COMP%]{box-sizing:border-box;margin:0;padding:0}html[_ngcontent-%COMP%], body[_ngcontent-%COMP%]{height:100%}body[_ngcontent-%COMP%]{background-color:#e3f2fd;font-family:Roboto,Helvetica Neue,sans-serif}body.dark-theme[_ngcontent-%COMP%]{background-color:#283593;color:#e3f2fd}a[_ngcontent-%COMP%], a[_ngcontent-%COMP%]:visited{color:#3f51b5}a[_ngcontent-%COMP%]:hover, a[_ngcontent-%COMP%]:visited:hover{opacity:.8}a[_ngcontent-%COMP%]:active, a[_ngcontent-%COMP%]:visited:active{opacity:.6}.dark-theme[_ngcontent-%COMP%]   a[_ngcontent-%COMP%], .dark-theme[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:visited{color:#e89126}.error-snackbar[_ngcontent-%COMP%]{width:fit-content;color:#3f51b5;background-color:#e3f2fd;border-bottom:3px solid #ff0000}.success-snackbar[_ngcontent-%COMP%]{width:fit-content;color:#3f51b5;background-color:#e3f2fd;border-bottom:3px solid #00ff00}button[_ngcontent-%COMP%]:disabled{color:#757575}.btn[_ngcontent-%COMP%]{height:36px;padding:0 1rem;align-self:flex-start;color:#fafafa;background-color:#424242;border-radius:4px;border:none;cursor:pointer}.btn[_ngcontent-%COMP%]:hover{opacity:.9}.btn[_ngcontent-%COMP%]:disabled{background-color:#b8b1b1;opacity:1;cursor:not-allowed}.input[_ngcontent-%COMP%]{width:100%;padding:0 .5rem;background-color:transparent;border:1px solid #3f51b5;border-radius:4px}.messages[_ngcontent-%COMP%]{max-height:50vh;display:flex;flex-direction:column;gap:.25rem;padding:.5rem;border:1px solid #283593;border-radius:4px;list-style:none;overflow:auto}.messages__item[_ngcontent-%COMP%]{margin-right:2rem;padding:.5rem;width:fit-content;display:flex;flex-direction:column;gap:.25rem;border:1px solid #3f51b5;border-radius:4px;background-color:#9cd1f8}.user-messages[_ngcontent-%COMP%]{margin-right:0;margin-left:2rem;align-self:flex-end}.spinner[_ngcontent-%COMP%]{margin-top:1rem;align-self:center}[_nghost-%COMP%]{max-width:800px;margin:0 auto;padding:1rem;display:flex;flex-direction:column;gap:1rem}.btn-wrapper[_ngcontent-%COMP%]{display:flex;gap:1rem}.input-wrapper[_ngcontent-%COMP%]{display:flex;gap:.5rem}.error-title[_ngcontent-%COMP%]{margin-top:3rem;font-size:2rem;text-align:center}.dark-theme[_nghost-%COMP%]   a[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   a[_ngcontent-%COMP%], .dark-theme[_nghost-%COMP%]   a[_ngcontent-%COMP%]:visited, .dark-theme   [_nghost-%COMP%]   a[_ngcontent-%COMP%]:visited{color:#e89126}.dark-theme[_nghost-%COMP%]   .input-wrapper[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .input-wrapper[_ngcontent-%COMP%]{display:flex;gap:.5rem}.dark-theme[_nghost-%COMP%]   .input[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .input[_ngcontent-%COMP%]{color:#e3f2fd;border-color:#e89126}.dark-theme[_nghost-%COMP%]   .messages[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .messages[_ngcontent-%COMP%]{border-color:#e89126}.dark-theme[_nghost-%COMP%]   .messages__item[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .messages__item[_ngcontent-%COMP%]{border-color:#e89126;background-color:#af6913}"]});let t=i;return t})();export{dt as ConversationComponent};
