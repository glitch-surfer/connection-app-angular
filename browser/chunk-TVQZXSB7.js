import{a as Oe,b as Pe}from"./chunk-HDBRL7X2.js";import{a as _e,b as Ce,c as xe}from"./chunk-4GU3OLUA.js";import{c as ue}from"./chunk-QMW4F7ZL.js";import"./chunk-ODEZCNH3.js";import"./chunk-5JDCOLZI.js";import{a as Se}from"./chunk-K5VTYB75.js";import{b as me,c as Me,d as be,f as ve}from"./chunk-FU4DWJD5.js";import"./chunk-UB4EZDCW.js";import{a as he}from"./chunk-QKVZ2CT4.js";import{b as oe}from"./chunk-GSZV43AH.js";import{a as re,b as se,c as ae,d as pe,f as ce,j as le,l as ge,o as de,y as M,z as fe}from"./chunk-2SKVBX5T.js";import"./chunk-S5VQBE6T.js";import{Aa as d,Ab as ee,Ca as p,Cb as te,Da as c,Db as ie,Ea as E,F,Fa as z,Fb as ne,Ga as q,H as C,Ia as k,L as N,Ma as I,O as _,Oa as m,Q as U,Ra as w,Sa as g,U as O,Ua as G,V as P,Va as Y,Xa as J,Za as r,_a as s,a as T,b as A,eb as R,f as x,h as b,l as h,la as a,lb as K,m as L,ma as $,mb as Q,qb as W,r as j,rb as X,sb as Z,t as V,v,va as l,xa as H,z as S}from"./chunk-5IAL5MBJ.js";var Ie=t=>t.dialogs;var De=(()=>{let o=class o{constructor(e,n,f,D,ye,$e,Ee){this.groupsHttpService=e,this.store=n,this.notificationService=f,this.router=D,this.peopleListService=ye,this.groupsListService=$e,this.dialog=Ee,this.since={},this.messagesRaw$=this.store.select(Ie).pipe(h(u=>u[this.groupId]?u[this.groupId].messages:[])),this.peoples$=this.store.select(be),this.loading$$=new x(!1),this.loading$=this.loading$$.asObservable(),this.groupId="",this.groupAuthorId$=this.store.select(Ce).pipe(h(u=>u.find(y=>y.id===this.groupId)?.createdBy)),this.userId$=this.store.select(he).pipe(h(u=>u.uid)),this.messages$=L([this.messagesRaw$,this.peoples$]).pipe(h(([u,y])=>u.map(B=>A(T({},B),{author:y.find(ke=>ke.uid===B.authorID)?.name??"Me"})))),this.timers={}}initDialog(){this.groupsListService.initGroupsList(),this.peopleListService.initPeoplesList(),this.getMessages()}setTimer(){let e=this.timers[this.groupId];if(e.getValue())return;let n=60,f=j(1e3).subscribe(()=>{if(n===0){f.unsubscribe();return}n-=1,e.next(n)})}getMessages(){this.loading$$.next(!0),this.groupsHttpService.getMessages(this.groupId,this.since[this.groupId]??"").pipe(h(e=>Se(e)),h(e=>e.sort((n,f)=>+n.createdAt-+f.createdAt).slice()),C(e=>{let n=!this.since[this.groupId];e.length>0&&(this.since[this.groupId]=e[e.length-1].createdAt),this.store.dispatch(n?Oe({groupId:this.groupId,messages:e}):Pe({groupId:this.groupId,messages:e}))}),v(()=>(this.notificationService.error(M.ERROR_LOAD_MESSAGES),b)),S(()=>this.loading$$.next(!1))).subscribe()}deleteGroup(){this.dialog.open(Me,{data:{title:"Delete group",content:"Are you sure you want to delete this group?",confirmButtonText:"Delete"}}).afterClosed().pipe(V(Boolean),C(()=>this.loading$$.next(!0)),F(()=>this.groupsHttpService.deleteGroup(this.groupId)),C(()=>this.store.dispatch(ue({id:this.groupId}))),C(()=>this.notificationService.success(M.SUCCESS_DELETED_GROUP)),C(()=>this.router.navigate(["/"])),v(()=>(this.notificationService.error(M.ERROR_DELETED_GROUP),b)),S(()=>this.loading$$.next(!1))).subscribe()}sendMessage(e){this.loading$$.next(!0),this.groupsHttpService.sendMessage(this.groupId,e).pipe(C(()=>this.getMessages()),v(()=>(this.notificationService.error(M.ERROR_SEND_MESSAGE),b)),S(()=>this.loading$$.next(!1))).subscribe()}};o.\u0275fac=function(n){return new(n||o)(_(_e),_(oe),_(fe),_(te),_(ve),_(xe),_(me))},o.\u0275prov=N({token:o,factory:o.\u0275fac,providedIn:"root"});let t=o;return t})();function Ae(t,o){t&1&&E(0,"mat-spinner",3)}function Le(t,o){if(t&1&&(p(0,"span"),g(1),r(2,"async"),c()),t&2){let i=m(3);a(1),G(" (timeout: ",s(2,1,i.timer$),")")}}function je(t,o){if(t&1){let i=k();p(0,"button",7),I("click",function(){O(i);let n=m(3);return P(n.onDeleteGroup())}),r(1,"async"),g(2," Delete "),c()}if(t&2){let i=m(3);l("disabled",s(1,1,i.loading$))}}function Ve(t,o){if(t&1&&(p(0,"li",14),r(1,"async"),p(2,"span"),g(3),r(4,"date"),c(),g(5),c()),t&2){let i=o.$implicit,e=m(3);H("user-messages",s(1,5,e.userId$)===i.authorID),a(3),G("(",s(4,7,i.createdAt),")"),a(2),Y(" ",i.author,": ",i.message," ")}}function Fe(t,o){t&1&&(p(0,"li"),g(1,"No messages yet"),c())}function Ne(t,o){if(t&1){let i=k();z(0),p(1,"div",6)(2,"button",7),I("click",function(){O(i);let n=m(2);return P(n.onUpdateMessages())}),r(3,"async"),r(4,"async"),g(5," Update"),d(6,Le,3,3,"span",8),r(7,"async"),c(),d(8,je,3,3,"button",9),r(9,"async"),r(10,"async"),c(),p(11,"ul",10),d(12,Ve,6,9,"li",11),r(13,"async"),d(14,Fe,2,0,"li",8),r(15,"async"),c(),p(16,"div",12),E(17,"input",13),p(18,"button",7),I("click",function(){O(i);let n=m(2);return P(n.onSendMessage())}),r(19,"async"),g(20," Send "),c()(),q()}if(t&2){let i=m(2),e;a(2),l("disabled",s(3,7,i.timer$)||s(4,9,i.loading$)),a(4),l("ngIf",s(7,11,i.timer$)),a(2),l("ngIf",s(9,13,i.userId$)===s(10,15,i.groupAuthorId$)),a(4),l("ngForOf",s(13,17,i.messages$)),a(2),l("ngIf",!((e=s(15,19,i.messages$))!=null&&e.length)),a(3),l("formControl",i.newMessage),a(1),l("disabled",s(19,21,i.loading$)||i.newMessage.invalid)}}function Ue(t,o){t&1&&(p(0,"p",15),g(1,"Gruop doesn't exist"),c())}function He(t,o){if(t&1&&(d(0,Ne,21,23,"ng-container",4),r(1,"async"),d(2,Ue,2,0,"ng-template",null,5,R)),t&2){let i=w(3),e=m();l("ngIf",!!s(1,2,e.groupAuthorId$))("ngIfElse",i)}}var Ct=(()=>{let o=class o{constructor(e,n){this.groupDialogService=e,this.router=n,this.newMessage=new le("",{validators:[pe.required]}),this.loading$=this.groupDialogService.loading$,this.messages$=this.groupDialogService.messages$,this.groupAuthorId$=this.groupDialogService.groupAuthorId$,this.userId$=this.groupDialogService.userId$}ngOnInit(){this.groupDialogService.groupId=this.router.snapshot.params.id,this.groupDialogService.timers[this.groupDialogService.groupId]||(this.groupDialogService.timers[this.groupDialogService.groupId]=new x(0)),this.timer$=this.groupDialogService.timers[this.groupDialogService.groupId],this.groupDialogService.initDialog()}onUpdateMessages(){this.groupDialogService.setTimer(),this.groupDialogService.getMessages()}onDeleteGroup(){this.groupDialogService.deleteGroup()}onSendMessage(){this.newMessage.invalid||!this.newMessage.value||(this.groupDialogService.sendMessage(this.newMessage.value),this.newMessage.setValue(""))}};o.\u0275fac=function(n){return new(n||o)($(De),$(ee))},o.\u0275cmp=U({type:o,selectors:[["app-group-dialog"]],standalone:!0,features:[J],decls:6,vars:4,consts:[["routerLink","/",1,"back-link"],["class","spinner",4,"ngIf","ngIfElse"],["content",""],[1,"spinner"],[4,"ngIf","ngIfElse"],["notExist",""],[1,"btn-wrapper"],[1,"btn",3,"disabled","click"],[4,"ngIf"],["class","btn",3,"disabled","click",4,"ngIf"],[1,"messages"],["class","messages__item",3,"user-messages",4,"ngFor","ngForOf"],[1,"input-wrapper"],["type","text","placeholder","Message",1,"input",3,"formControl"],[1,"messages__item"],[1,"error-title"]],template:function(n,f){if(n&1&&(p(0,"a",0),g(1,"Back"),c(),d(2,Ae,1,0,"mat-spinner",1),r(3,"async"),d(4,He,4,4,"ng-template",null,2,R)),n&2){let D=w(5);a(2),l("ngIf",s(3,2,f.loading$))("ngIfElse",D)}},dependencies:[Z,K,Q,W,X,ne,ie,de,ae,ce,ge,se,re],styles:["*[_ngcontent-%COMP%]{box-sizing:border-box;margin:0;padding:0}html[_ngcontent-%COMP%], body[_ngcontent-%COMP%]{height:100%}body[_ngcontent-%COMP%]{background-color:#e3f2fd;font-family:Roboto,Helvetica Neue,sans-serif}body.dark-theme[_ngcontent-%COMP%]{background-color:#283593;color:#e3f2fd}a[_ngcontent-%COMP%], a[_ngcontent-%COMP%]:visited{color:#3f51b5}a[_ngcontent-%COMP%]:hover, a[_ngcontent-%COMP%]:visited:hover{opacity:.8}a[_ngcontent-%COMP%]:active, a[_ngcontent-%COMP%]:visited:active{opacity:.6}.dark-theme[_ngcontent-%COMP%]   a[_ngcontent-%COMP%], .dark-theme[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]:visited{color:#e89126}.error-snackbar[_ngcontent-%COMP%]{width:fit-content;color:#3f51b5;background-color:#e3f2fd;border-bottom:3px solid #ff0000}.success-snackbar[_ngcontent-%COMP%]{width:fit-content;color:#3f51b5;background-color:#e3f2fd;border-bottom:3px solid #00ff00}button[_ngcontent-%COMP%]:disabled{color:#757575}.btn[_ngcontent-%COMP%]{height:36px;padding:0 1rem;align-self:flex-start;color:#fafafa;background-color:#424242;border-radius:4px;border:none;cursor:pointer}.btn[_ngcontent-%COMP%]:hover{opacity:.9}.btn[_ngcontent-%COMP%]:disabled{background-color:#b8b1b1;opacity:1;cursor:not-allowed}.input[_ngcontent-%COMP%]{width:100%;padding:0 .5rem;background-color:transparent;border:1px solid #3f51b5;border-radius:4px}.messages[_ngcontent-%COMP%]{max-height:50vh;display:flex;flex-direction:column;gap:.25rem;padding:.5rem;border:1px solid #283593;border-radius:4px;list-style:none;overflow:auto}.messages__item[_ngcontent-%COMP%]{margin-right:2rem;padding:.5rem;width:fit-content;display:flex;flex-direction:column;gap:.25rem;border:1px solid #3f51b5;border-radius:4px;background-color:#9cd1f8}.user-messages[_ngcontent-%COMP%]{margin-right:0;margin-left:2rem;align-self:flex-end}.spinner[_ngcontent-%COMP%]{margin-top:1rem;align-self:center}[_nghost-%COMP%]{max-width:800px;margin:0 auto;padding:1rem;display:flex;flex-direction:column;gap:1rem}.btn-wrapper[_ngcontent-%COMP%]{display:flex;gap:1rem}.input-wrapper[_ngcontent-%COMP%]{display:flex;gap:.5rem}.error-title[_ngcontent-%COMP%]{margin-top:3rem;font-size:2rem;text-align:center}.dark-theme[_nghost-%COMP%]   a[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   a[_ngcontent-%COMP%], .dark-theme[_nghost-%COMP%]   a[_ngcontent-%COMP%]:visited, .dark-theme   [_nghost-%COMP%]   a[_ngcontent-%COMP%]:visited{color:#e89126}.dark-theme[_nghost-%COMP%]   .input[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .input[_ngcontent-%COMP%]{color:#e3f2fd;border-color:#e89126}.dark-theme[_nghost-%COMP%]   .messages[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .messages[_ngcontent-%COMP%]{border-color:#e89126}.dark-theme[_nghost-%COMP%]   .messages__item[_ngcontent-%COMP%], .dark-theme   [_nghost-%COMP%]   .messages__item[_ngcontent-%COMP%]{border-color:#e89126;background-color:#af6913}"]});let t=o;return t})();export{Ct as GroupDialogComponent};
